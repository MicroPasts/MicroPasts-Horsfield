<!-- Styles for this task -->
<link type="text/css" rel="stylesheet" href="http://annotorious.github.io/latest/themes/dark/annotorious-dark.css"/>
<link rel="stylesheet" href="/static/vendor/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<link rel="stylesheet" href="/static/vendor/bootstrap-multiselect/css/bootstrap-multiselect.css" type="text/css" media="screen" />
<!-- Multi-select scripts -->
<script src="/static/vendor/bootstrap-multiselect/js/bootstrap-multiselect.js" type="text/javascript"></script>
<!-- Fancy box script -->
<script src="/static/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<!-- jQuery cookie -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js" type="text/javascript"></script>
<!-- Annotorious -->
<script src="http://annotorious.github.io/latest/annotorious.min.js" type="text/javascript"></script>
<script src="http://annotorious.github.io/latest/anno-fancybox.min.js" type="text/javascript"></script>

<!-- jquery form serializer -->
<script src="/static/js/vendor/jquery.serializeJSON.min.js" type="text/javascript"></script>
<!-- Maps -->
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<!-- jquery ui -->
<script src="https://code.jquery.com/ui/1.8.1/jquery-ui.min.js" type="text/javascript"></script>

<!-- Get fancy box selector working --> 
<script>
   anno.addPlugin('FancyBoxSelector', { activate: true });
</script>

<!-- App specific styles -->
<style>
    .messageMargin {
        margin-top: 15px;
    }
    .loadingIcon {
        max-width:100%;
    }
    .none {
        display:none;
    }
    .ui-autocomplete {
        background-color: white;
        width: 300px;
        border: 1px solid #cfcfcf;
        list-style-type: none;
        padding: 10px;

    }
    #map {
        height:400px;
        width:100%;
        margin-top: 15px;
    }
    #keywords .btn-group {
        margin-top: 0px;
        margin-bottom: 0px;
    }
</style>

<!-- The surveys for Chiara -->
    <!-- Basic 1 task -->
    <div id="survey" class="modal fade" data-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Hello! Do you want to help us?</h4>
          </div>
          <div class="modal-body">
              <p>Thanks for contributing one task for the project. We are
                  interested in knowing how you found out about us.
                  <strong>Could you please answer two questions in a short survey?</strong>
              </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Skip</button>
            <a class="btn btn-large btn-success" href="https://docs.google.com/forms/d/1lNhBvKqPQlaJpWcvbEMfOGlixf7BHC__9w9JYs0Yw_4/viewform">Of course! Take me to the survey!</a>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- The complex 25 task -->
    <div id="survey25" class="modal fade" data-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Hello! Do you want to help us?</h4>
          </div>
          <div class="modal-body">
              <p>
                  Thanks for contributing 25 tasks for the project. We are
                  interested in knowing how you found out about us.
                  <strong>Could you please answer two questions in a short survey?</strong>
              </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Skip</button>
            <a class="btn btn-large btn-success" href="https://docs.google.com/forms/d/1fchE1-eZ-ikceVMSEyXt5SW3-7bsFVLaIaPwBBiDnLA/viewform?embedded=true">Of course! Take me to the survey!</a>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- Success and Error Messages for the user -->

    <div class="messageMargin">
       <div id="success" class="alert alert-success none">
          <h2>Well done!</h2>
          <p>
              You have successfully submitted your tags. Here is another
              photograph to try if you wish!
          </p>
       </div>
       <div id="loading" class="alert alert-info none">
          <img src="/static/img/loading.gif">Loading next task...
       </div>
       <div id="taskcompleted" class="alert alert-info none">
          <h2>The task has been completed!</h2>
          <p>
              Thank you for participating!
          </p>
       </div>
       <div id="finish" class="alert alert-success none">
          <h2>Congratulations!</h2>
          <p>
              You have participated in all available tasks!
          </p>
          <img src="https://crowdfunded.micropasts.org/assets/logo-head.png"
               height="200" width="200" alt="The MicroPasts Square Logo"/>
          <div class="alert-actions">
             <a class="btn-default btn" href="/">Go back to the home page</a>
             <a class="btn-default btn" href="/app">or, have a look at our
                 other applications</a>
          </div>
       </div>
       <div id="error" class="alert alert-error none">
          <a class="close">Ã—</a>
          <h2>Error!</h2>
          <p>
              Something went wrong, please contact the site administrators via the
              <a href="http://community.micropasts.org">forum</a>,
              <a href="https://facebook.com/micropasts">Facebook</a>,
              <a href="mailto:info@finds.org.uk">email</a> or
              <a href="https://twitter.com/micropasts">Twitter</a>.
          </p>
       </div>
    </div>

    <!-- End Success and Error Messages for the user -->

    <!--
        Task DOM for loading the Flickr Images
        It uses the class="skeleton" to identify the elements that belong to the
        task.
    -->
    <!-- Start Skeleton Row -->
    <div class="row skeleton">

       <!-- Start of Question and Submission DIV -->
       <div class="btn-group pull-right">
          <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal"><i class="glyphicon glyphicon-eye-open"></i> Tutorial</button>
          <a class="btn btn-info btn-sm" id="imgLink" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="http://community.micropasts.org/category/crowdsourcing-support"><i class="glyphicon glyphicon-book"></i> Community Help</a>
          <a id="raw" href="" class="btn btn-sm btn-info fancybox" ><i class="glyphicon glyphicon-picture"></i> Overlay</a>
          <a id="flickr" rel="tooltip" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="" class="btn btn-sm btn-info"><i class="icon icon-flickr"></i> View on Flickr</a>
          <a id="down" rel="tooltip" data-toggle="tooltip" data-placement="top" title="Only works for compliant browsers" download="" href="" class="btn btn-sm btn-info" ><i class="glyphicon glyphicon-download"></i> Download</a>
       </div>

       <h1 id="step1">Please help us to tag this photograph</h1>
       <div class="btn-group">
          <button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">Loading photo</button>
        </div>


       <div class="col-md-12"><!-- Start of Photo DIV (column) -->
          <div id="imgContainer" >
             <span id="photo-link">
                <img id="photo" src="/static/img/loading.gif" class="loadingIcon">
             </span>
          </div>
       </div><!-- End of Photo DIV (column) -->
    <form id="phototagging" role="form">
        <div class="col-md-12">
            <h1>
                Enter some information about the image you can see
            </h1>
        </div>

       <div class="col-md-6">
           <h2>
               Choose some keywords
           </h2>
           <p>
               You can choose multiple keywords for each photograph shown above.
           </p>
          <div class="btn-group" id="keywords">

           <select id="activities" class="multiselect" multiple="multiple">
                <option value="Agriculture">Agriculture</option>
                <option value="Craft">Craft</option>
                <option value="Dance">Dance</option>
                <option value="Excavation">Excavation</option>
            </select>

            <select id="object" class="multiselect" multiple="multiple">
                <option value="Aeroplane">Aeroplane</option>
                <option value="Altar">Altar</option>
                <option value="Animal">Animal</option>
                <option value="Ape">Ape</option>
            </select>

            <select id="theme" class="multiselect" multiple="multiple">
                <option value="Animal">Animal</option>
                <option value="Architecture">Architecture</option>
                <option value="Armour">Armour</option>
                <option value="Container">Container</option>
            </select>

            <select id="cultural" class="multiselect" multiple="multiple">
                <option value="American">American</option>
                <option value="Arab">Arab</option>
                <option value="Bedouin">Bedouin</option>
                <option value="Egyptian">Egyptian</option>
            </select>
        </div>
           <hr />
             <div class="form-group">
                    <label class="control-label" for="keywordsUser">Other keywords:</label>
                        <input type="text" name="keywordsUser" class="form-control" placeholder="If you think other keywords, enter them here separated by commas">
                </div>

             <div class="form-group">
                <label class="control-label" for="imageLabel">Transcribe the label: </label>
                <textarea class="form-control" rows="5" id="imageLabel" name="imageLabel"
                          placeholder="Transcribe the label from the image above"></textarea>
             </div>

             <div class="form-group">
                <label class="control-label" for="comments">Your Comments</label>
                <textarea class="form-control" rows="5" id="comments" name="comments"
                          placeholder="Add any comments you may have about the photo."></textarea>
             </div>

        </div>


    <div class="col-md-6">
        <!-- Geographical grouping -->
        <div class="form-group" id="geo">

            <div>
                <label class="control-label" for="site">Geo-reference the site</label>
                <input type="text" class="form-control" id="toSearch" name="toSearch"
                       placeholder="Locate the site on a map"></input>
                <input type="hidden"  name="lat" value="" id="lat">
                <input type="hidden"  name="lon" value="" id="lon">
            </div>

            <div id="map">
            </div>
            <div>
                <label class="control-label" for="pleiadesID">Look up a Pleiades Identifier: </label>
                <select class="form-control" id="pleiadesID" name="pleiadesID">
                    <option>Please choose a place</option>
                    <option value="697728" >Amman, Jordan - Amman/Philadelpheia</option>
                    <option value="678158">Jerash - Gerasa/Antiochia ad Chrysorhoam</option>
                    <option value="697725">Petra, Jordan</option>
                    </select>
              <h4>Why use Pleiades tags</h4>
                <p>
                    <a rel="tooptip" data-placement="top" data-toggle="tooltip" title="" data-original-title="The Pleiades site - opens in a new window" href="http://pleiades.stoa.org/" target="_blank">Pleiades</a> is a community-built gazetteer and graph of ancient places.. By adding these identifiers, we can assist their efforts. 
                </p>
            </div>
        </div>
        <!-- End of geo group -->
    </div>
    </form>

       <div class="col-md-12">
          <div class="btn-group">
             <button class="btn btn-success btn-answer" value='Yes'>
                 <i class="icon icon-white icon-save"></i> Submit your answer
             </button><!--id="btn-save"-->
          </div>

          <!-- Feedback items for the user -->
          <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
          <p>You have completed: <span id="done" class="label label-info"></span> tasks from
          <!-- Progress bar for the user -->
          <span id="total" class="label label-inverse"></span></p>
          <div class="progress progress-striped">
             <div id="progress" class="progress-bar" role="progressbar" rel="tooltip"
                  title="#" class="bar" style="width:0%;"></div>
          </div>
          <div id="answer"></div><!-- DIV for the submission buttons -->
        </div>
       <!-- End of Question and Submission DIV (column) -->
    </div><!-- End of Skeleton Row -->

    <!-- Modal start -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
       <div class="modal-dialog">
          <div class="modal-content">
             <div class="modal-header"><h3>Photo-tagging Tutorial</h3></div><!-- Modal header -->
             <div id="0" class="modal-body" style="display:none">
                <p>
                The application is really simple. It loads a photo from <a href="http://flickr.com">Flickr</a> and asks you to <strong>tag all the elements that you recognise</strong>. These can be anything from 'objects' such as a <i>column</i> or a <i>camel</i>, an activity taken place such as <i>agriculture</i> or <i>transport</i>, a certain cultural group of people such as <i>Bedouin</i> or <i>European</i>, and/or more general themes such as simply <i>architecture</i>.
                </p>
                <p>
                You then hover the mouse over the elements that you identify, and then by clicking and dragging you will draw a box. A text box will appear, in which you will be able to type the name of that element and save it.
                </p>
                <p>
                <img src="https://farm3.staticflickr.com/2918/14443363844_d99632eb9b.jpg" width="500" height="332" alt="An example of the tagging interface"/>
                </p>
                <p>
                You can do this as many times as you want. If you wish to edit a tag or delete it altogether, you can do this by hovering over the relevant box, and then selecting either the pencil tool for editing, or the 'x' for deleting.
                </p>
                <p>
                If the photo has a caption, please select that area and type in the caption's text.
                </p>
                <p>
                As you can see, you have four buttons representing four categories of suggested keywords: Activity, Object, Theme and Cultural Group. Click on each one of these will bring up a list of suggested keywords to be used in tagging. You can refer to these lists when tagging each photo, but you can also add your own tags. Under the photo you will find a text box in which you can add any comments you might have.
                </p>
             </div>
             <div id="1" class="modal-body" style="display:none">
                <p>
                During the task, you can always return to this tutorial via the "Help" button.
                </p>
                <p>
                <i class="glyphicon glyphicon-eye-open"></i> To find out how the project is progressing, to suggest changes to this application or to propose new research ideas based what you have tagged, please have a look at our <a href="http://community.micropasts.org" title="Community forum">community forum</a>.
                </p>
             </div>
          <!-- End of stepped modal body -->

          <!-- Modal footer -->
          <div class="modal-footer">
             <a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
             <a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
             <button id="startContrib" data-dismiss="modal" class="btn btn-primary" style="display:none"><i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal end -->
    <!-- Enable the multi selects -->
    <script>
        $(document).ready(function() {
            $('.multiselect').multiselect({
            numberDisplayed: 2
            });
        });
    </script>

    <!-- The modal steps -->
    <script>
    var step = -1;
    function showStep(action) {
       $("#" + step).hide();
       if (action == 'next') {
          step = step + 1;
       }
       if (action == 'prev') {
          step = step - 1;
       }
       if (step == 0) {
          $("#prevBtn").hide();
       }
       else {
          $("#prevBtn").show();
       }
       if (step == 1) {
          $("#nextBtn").hide();
          $("#startContrib").show();
       }
       $("#" + step).show();
    }
    showStep('next');
    $("#modal").modal('show');
    </script>

    <!-- The geocoder -->
    <script>
    var geocoder;
    var map;
    var marker;

    function initialize(){
    //MAP
      var latlng = new google.maps.LatLng(31.95, 35.94);
      var options = {
        zoom: 9,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.TERRAIN
      };

      map = new google.maps.Map(document.getElementById("map"), options);

      //GEOCODER
      geocoder = new google.maps.Geocoder();

      marker = new google.maps.Marker({
        map: map,
        draggable: true
      });

    }

    $(document).ready(function() {

      initialize();

      $(function() {
        $("#toSearch").autocomplete({
          //This bit uses the geocoder to fetch address values
          source: function(request, response) {
            geocoder.geocode( {'address': request.term }, function(results, status) {
              response($.map(results, function(item) {
                return {
                  label:  item.formatted_address,
                  value: item.formatted_address,
                  latitude: item.geometry.location.lat(),
                  longitude: item.geometry.location.lng()
                }
              }));
            })
          },
          //This bit is executed upon selection of an address
          select: function(event, ui) {
            $("#lat").val(ui.item.latitude);
            $("#lon").val(ui.item.longitude);
            var location = new google.maps.LatLng(ui.item.latitude, ui.item.longitude);
            console.log('Latitude: ' + ui.item.latitude);
            console.log('Longitude: ' + ui.item.longitude);
            marker.setPosition(location);
            map.setCenter(location);
          }
        });
      });

      //Add listener to marker for reverse geocoding
      google.maps.event.addListener(marker, 'drag', function() {
        geocoder.geocode({'latLng': marker.getPosition()}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            if (results[0]) {
              $('#toSearch').val(results[0].formatted_address);
              $('#lat').val(marker.getPosition().lat());
              $('#lon').val(marker.getPosition().lng());
              console.log('Longitude: ' + marker.getPosition().lng());
              console.log('Latitude: ' + marker.getPosition().lat());
            }
          }
        });
      });

    });

    </script>

    <script>
        function deleteMarker() {
            marker.setMap(null);
            marker=null;
            map.setCenter(new google.maps.LatLng(31.95, 35.94));
        }
    </script>
    <!-- Load user progress -->
    <script>

function resetForm($form) {
    $form.find('input:text, input:password, input:file, select, textarea').val('');
    $form.find('input:radio, input:checkbox')
         .removeAttr('checked').removeAttr('selected');
}
    function loadUserProgress() {
        pybossa.userProgress('phototaggingHorsfield').done(function(data){

            console.log("Total answers done for user: " + data.done);

            if ((data.done == 1) && ($.cookie('surveyHorsfield') == undefined)){
               $("#survey").modal('show');
               $.cookie('surveyHorsfield', 'shown', { path: '/'});
            }
            if ((data.done >= 25) && ($.cookie('survey25Horsfield') == undefined)){
                $("#survey25").modal('show');
                $.cookie('survey25Horsfield', 'shown', { path: '/'});
            }
            var pct = Math.round((data.done*100)/data.total);
            $("#progress").css("width", pct.toString() +"%");
            $("#progress").attr("title", pct.toString() + "% completed!");
            $("#progress").tooltip({'placement': 'left'});
            $("#total").text(data.total);
            $("#done").text(data.done);
        });
    }

    pybossa.taskLoaded(function(task, deferred) {
        if ( ! $.isEmptyObject(task) ) {
            loadUserProgress();
            // load image from flickr
            var img = $('<img />');
            img.load(function() {
                // continue as soon as the image is loaded
                deferred.resolve(task);
                $("#status").text("Photo loaded!");

            });
            // Flickr uses different suffixes for different picture sizes:
            // _s.jpg    small square 75x75
            // _q.jpg    large square 150x150
            // _t.jpg    thumbnail, 100 on longest side
            // _m.jpg    small, 240 on longest side
            // _n.jpg    small, 320 on longest side
            // .jpg      medium, 500 on longest side
            // _z.jpg    medium 640, 640 on longest side
            // _c.jpg    medium 800, 800 on longest side
            // _b.jpg    large, 1024 on longest side*
            // _o.jpg    original image, either a jpg, gif or png, depending on source format
            img.attr('src', task.info.url_b);
            img.attr('id', 'anno_' + task.id);
            img.addClass('img-polaroid');
            img.addClass('annotable');
            task.info.image = img;
        }
        else {
            deferred.resolve(task);
        }
    });

    pybossa.presentTask(function(task, deferred) {
        if ( !$.isEmptyObject(task) ) {
            $('#photo-link').html('').append(task.info.image);
            $('#task-id').html(task.id);
            $("a#raw").attr("href", task.info.url_b);
            $("a#flickr").attr("href", task.info.link + '/sizes/k/');
            $("a#down").attr("download", task.id);
            $("a#down").attr("href", task.info.url_b );
            $(".fancybox").fancybox();
            $('#imgLink').tooltip();
            $("[rel=tooltip]").tooltip();
            $("#btn-submit").html("<i class='icon-repeat'></i> I don't recognise anything, try next one");
            $("#btn-submit").removeClass("btn-success");

            anno.makeAnnotatable(document.getElementById('anno_' + task.id));

            anno.addHandler('onAnnotationCreated', function(annotation) {
                console.log(annotation.text);
                $("#btn-submit").html("<i class='icon icon-save'></i> Save current annotations");
                $("#btn-submit").addClass("btn-success");
            });


            $('.btn-answer').off('click').on('click', function(evt) {
                var answer = $(evt.target).attr("value");
                if (typeof answer != 'undefined') {
                    console.log(answer);
                    task.answer = $("#phototagging").serializeJSON();
                    task.answer.annotations = anno.getAnnotations();
                    task.answer.theme = $('#theme').val();
                    task.answer.cultural = $('#cultural').val();
                    task.answer.object = $('#object').val();
                    task.answer.activities = $('#activities').val();
                    console.log(task.answer);
                    pybossa.saveTask(task.id, task.answer).done(function() {
                        deferred.resolve();
                    });
                    $( '#phototagging' ).each(function(){
                    this.reset();
                    });

                    resetForm($('#phototagging'));
                    $('input').val('');
                    $( '#theme' ).multiselect('refresh');
                    $( '#object' ).multiselect('refresh');
                    $( '#activities' ).multiselect('refresh');
                    $( '#cultural' ).multiselect('refresh');
                    deleteMarker();
                } else {
                    $("#error").show();
                }
            });
            $("#loading").hide();
        } else {
            $(".skeleton").hide();
            $("#loading").hide();
            $("#finish").fadeIn(500);
        }
    });
    pybossa.run('phototaggingHorsfield');

    </script>