<link type="text/css" rel="stylesheet" href="http://annotorious.github.io/latest/themes/dark/annotorious-dark.css"/>
<link rel="stylesheet" href="/static/vendor/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script src="/static/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<script src="http://annotorious.github.io/latest/annotorious.full.js" type="text/javascript"></script>
<script src="http://annotorious.github.io/latest/anno-fancybox.min.js" type="text/javascript"></script>
<script>
   anno.addPlugin('FancyBoxSelector', { activate: true });
</script>


<div id="survey" class="modal fade" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Hey there! Do you want to help us?</h4>
      </div>
      <div class="modal-body">
          Thanks for contributing one task for the project. We are interested in knowing how you found out about us. <strong>Could you please answer two questions in a short survey?</strong>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Skip</button>
        <a class="btn btn-large btn-success" href="https://docs.google.com/forms/d/1lNhBvKqPQlaJpWcvbEMfOGlixf7BHC__9w9JYs0Yw_4/viewform?embedded=true">Of course! Take me to the survey!</a>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Success and Error Messages for the user --> 
<div style="margin-top:15px;">
   <div id="success" class="alert alert-success" style="display:none;">
      <strong>Well done!</strong> You have successfully submitted your tags. Here is another photograph to try if you wish!
   </div>        
   <div id="loading" class="alert alert-info" style="display:none;">
      <img src="/static/img/loading.gif">Loading next task...
   </div>
   <div id="taskcompleted" class="alert alert-info" style="display:none;">
      <strong>The task has been completed!</strong> Thanks a lot!
   </div>
   <div id="finish" class="alert alert-success" style="display:none;">
      <strong>Congratulations!</strong> You have participated in all available tasks!
      <div class="alert-actions">
         <a class="btn-default btn" href="/">Go back</a>
         <a class="btn-default btn" href="/app">or, Check other applications</a>
      </div>
   </div>
   <div id="error" class="alert alert-error" style="display:none;">
      <a class="close">Ã—</a>
      <strong>Error!</strong> Something went wrong, please contact the site administrators
   </div>
</div><!-- End Success and Error Messages for the user -->

<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->
<!-- Start Skeleton Row -->    
<div class="row skeleton">

   <div class="btn-group pull-right">
      <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal"><i class="glyphicon glyphicon-eye-open"></i> Tutorial</button>
      <a class="btn btn-info btn-sm" id="imgLink" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="http://community.micropasts.org/category/crowdsourcing-support"><i class="glyphicon glyphicon-book"></i> Community Help</a>
      <a id="raw" href="" class="btn btn-sm btn-info fancybox" ><i class="glyphicon glyphicon-picture"></i> Overlay</a>
      <a id="flickr" rel="tooltip" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="" class="btn btn-sm btn-info"><i class="icon icon-flickr"></i> View on Flickr</a>
      <a id="down" rel="tooltip" data-toggle="tooltip" data-placement="top" title="Only works for compliant browsers" download="" href="" class="btn btn-sm btn-info" ><i class="glyphicon glyphicon-download"></i> Download</a>
   </div>

   <h1 id="step1">Please tag this photograph</h1>
   <div class="btn-group">
      <button id="status" type="button" class="btn btn-default btn-type disabled" name="loading" value="loading">Loading photo</button>
    </div>

   <div class="btn-group">
      <button id="keywords" type="button" class="btn btn-default btn-type btn-keywords disabled" name="keywords" value="keywords">Suggested Keywords:</button>
   </div>
   <div class="btn-group">
      <button id="activity" type="button" class="btn btn-primary btn-keywords dropdown-toggle" data-toggle="dropdown">Activity <span class="caret"></span></button>
      <ul class="dropdown-menu" role="menu">
         <li><a href="#">agriculture</a></li>
         <li><a href="#">craft</a></li>
         <li><a href="#">dance</a></li>
         <li><a href="#">excavation</a></li>
      </ul>
   </div>
   <div class="btn-group">  
      <button id="object" type="button" class="btn btn-success btn-keywords dropdown-toggle" data-toggle="dropdown">Object <span class="caret"></span></button>
      <ul class="dropdown-menu" role="menu">
         <li><a href="#">aeroplane</a></li>
         <li><a href="#">altar</a></li>
         <li><a href="#">animal</a></li>
         <li><a href="#">ape</a></li>
      </ul>
   </div>
   <div class="btn-group">
      <button id="theme" type="button" class="btn btn-warning btn-keywords dropdown-toggle" data-toggle="dropdown">Theme <span class="caret"></span></button>
      <ul class="dropdown-menu" role="menu">
         <li><a href="#">animal</a></li>
         <li><a href="#">architecture</a></li>
         <li><a href="#">armour</a></li>
         <li><a href="#">container</a></li>
      </ul>
   </div>
   <div class="btn-group">
      <button id="cultgroup" type="button" class="btn btn-danger btn-keywords dropdown-toggle" data-toggle="dropdown">Cultural Group <span class="caret"></span></button>
      <ul class="dropdown-menu" role="menu">
         <li><a href="#">American</a></li>
         <li><a href="#">Arab</a></li>
         <li><a href="#">Bedouin</a></li>
         <li><a href="#">Egyptian</a></li>
         <li><a href="#">European</a></li>
      </ul>
   </div>
</div><!-- End of Skeleton Row -->

<div class="row skeleton"><!-- Start Skeleton Row-->

   <div class="col-md-12"><!-- Start of Photo DIV (column) -->
      <!-- some of these divs are redundant: -->
      <div id="imgContainer" >
         <span id="photo-link">
            <img id="photo" src="http://i.imgur.com/GeHxzb7.png" style="max-width:100%">
         </span>
      </div>
      <div id="taskImg"></div>
   </div><!-- End of Photo DIV (column) -->

   <div class="col-md-4">
      <!-- Start of Question and Submission DIV (column) -->
      <p>&nbsp;</p>
      <form id="phototagging" role="form">
      <div class="form-group">
         <label class="control-label" for="comments">Your Comments</label>
         <textarea class="form-control" rows="5" name="other" placeholder="Add here your comments, if any."></textarea>
      </div>
      </form>

      <div class="btn-group">
         <button id="btn-save" class="btn btn-success btn-answer" value='save'><i class="icon icon-white icon-save"></i> Submit your tags</button>
      </div>

      <!-- Feedback items for the user -->
      <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
      <p>You have completed: <span id="done" class="label label-info"></span> tasks from
      <!-- Progress bar for the user -->
      <span id="total" class="label label-inverse"></span></p>
      <div class="progress progress-striped">
         <div id="progress" class="progress-bar" role="progressbar" rel="tooltip" title="#" class="bar" style="width:0%;"></div>
      </div>
      <div id="answer"></div><!-- DIV for the submission buttons -->
    </div><!-- End of Question and Submission DIV (column) -->

</div><!-- End of Skeleton Row -->

<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">       
         <div class="modal-header"><h3>Photo-tagging Tutorial</h3></div><!-- Modal header --> 
         <div id="0" class="modal-body" style="display:none">
            <p>
            The application is really simple. It loads a photo from <a href="http://flickr.com">Flickr</a> and asks you to <strong>tag all the elements that you recognise</strong>. These can be anything from 'objects' such as a <i>column</i> or a <i>camel</i>, an activity taken place such as <i>agriculture</i> or <i>transport</i>, a certain cultural group of people such as <i>Bedouin</i> or <i>European</i>, and/or more general themes such as simply <i>architecture</i>.
            </p>
            <p>
            You then hover the mouse over tha elements that you identify, and then by clicking and dragging you will draw a box. A text box will appear, in which you will be able to type the name of that element and save it.
            </p>
            <p>
            <img src="https://farm3.staticflickr.com/2918/14443363844_d99632eb9b.jpg" width="500" height="332" alt="An example of the tagging interface"/>
            </p>
            <p>
            You can do this as many times as you want. If you wish to edit a tag or delete it altogether, you can do this by hovering over the relevant box, and then selecting either the pencil tool for editing, or the 'x' for deleting.
            </p> 
            <p>
            If the photo has a caption, please select that area and type in the caption's text.
            </p> 
            <p>
            As you can see, you have four buttons representing four categories of suggested keywords: Activity, Object, Theme and Cultural Group. Click on each one of these will bring up a list of suggested keywords to be used in tagging. You can refer to these lists when tagging each photo, but you can also add your own tags. Under the photo you will find a text box in which you can add any comments you might have. 
            </p> 
         </div>
         <div id="1" class="modal-body" style="display:none">
            <p>
            During the task, you can always return to this tutorial via the "Help" button.
            </p> 
            <p>
            To find out how the project is progressing, to suggest changes to this application or to propose new research ideas based what you have tagged, please have a look at our <a href="http://community.micropasts.org" title="Community forum">community forum</a>.
            </p> 
         </div>
      <!-- End of stepped modal body -->

      <!-- Modal footer -->
      <div class="modal-footer">
         <a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
         <a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
         <button id="startContrib" data-dismiss="modal" class="btn btn-primary" style="display:none"><i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
      </div>
    </div>
  </div>
</div>
<!-- Modal end --> 

<script>
var step = -1;
function showStep(action) {
   $("#" + step).hide();
   if (action == 'next') {
      step = step + 1;
   }
   if (action == 'prev') {
      step = step - 1;
   }
   if (step == 0) {
      $("#prevBtn").hide();
   }
   else {
      $("#prevBtn").show();
   }
   if (step == 1) {
      $("#nextBtn").hide();
      $("#startContrib").show();
   }
   $("#" + step).show();
}
showStep('next');
$("#modal").modal('show');
</script>

<script>
function loadUserProgress() {
    pybossa.userProgress('phototaggingHorsfield').done(function(data){
        console.log("Total answers done for user: " + data.done);
        console.log(data);
        if ((data.done == 1) && ($.cookie('survey') === undefined)){
           $("#survey").modal('show');
           $.cookie('survey', 'shown', { path: '/'});
        }
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'});
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

pybossa.taskLoaded(function(task, deferred) {
    if ( ! $.isEmptyObject(task) ) {
    	loadUserProgress();
        // load image from flickr
        var img = $('<img />');
        img.load(function() {
            // continue as soon as the image is loaded
            deferred.resolve(task);
            $("#status").text("Photo loaded!");
        });
        // Flickr uses different suffixes for different picture sizes:
        // _s.jpg    small square 75x75
        // _q.jpg    large square 150x150
        // _t.jpg    thumbnail, 100 on longest side
        // _m.jpg    small, 240 on longest side
        // _n.jpg    small, 320 on longest side
        // .jpg      medium, 500 on longest side
        // _z.jpg    medium 640, 640 on longest side
        // _c.jpg    medium 800, 800 on longest side
        // _b.jpg    large, 1024 on longest side*
        // _o.jpg    original image, either a jpg, gif or png, depending on source format
        img.attr('src', task.info.url_b); 
        img.attr('id', 'anno_' + task.id);
        img.addClass('img-polaroid');
        img.addClass('annotable');
        task.info.image = img;
    }
    else {
        deferred.resolve(task);
    }
});

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        $('#photo-link').html('').append(task.info.image);
        //$("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $("a#raw").attr("href", task.info.url_b);
	      $("a#flickr").attr("href", task.info.link + '/sizes/k/');
	      $("a#down").attr("download", task.id);
	      $("a#down").attr("href", task.info.url_b );
        $(".fancybox").fancybox();
        $('#imgLink').tooltip();
        $("[rel=tooltip]").tooltip();
        
        $("#btn-submit").html("<i class='icon-repeat'></i> I don't recognise anything, try next one");
        $("#btn-submit").removeClass("btn-success");

        anno.makeAnnotatable(document.getElementById('anno_' + task.id));

        anno.addHandler('onAnnotationCreated', function(annotation) {
            console.log(annotation.text);
            $("#btn-submit").html("<i class='icon icon-save'></i> Save current annotations");
            $("#btn-submit").addClass("btn-success");
        });

        $('.btn-answer').off('click').on('click', function(evt) {
            var answer = $(evt.target).attr("value");
            if (typeof answer != 'undefined') {
                console.log(answer);
                pybossa.saveTask(task.id, anno.getAnnotations()).done(function() {
                    deferred.resolve();
                });
                $("#loading").fadeIn(500);
            }
            else {
                $("#error").show();
            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
    $('#imgLink').tooltip();
});
pybossa.run('phototaggingHorsfield');
</script>
